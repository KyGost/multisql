stages:
  - build
  - test
  - lint
  - release
  - benchmark

build:
  stage: build
  script: cargo build --target-dir ~/.cache/build-output/
  artifacts:
    paths:
      - debug/

test:
  stage: test
  script: cargo test --tests --target-dir ~/.cache/build-output/

doc-test:
  stage: test
  script: cargo test --doc --target-dir ~/.cache/build-output/

check-clippy:
  stage: lint
  script: cargo clippy --target-dir ~/.cache/build-output/
  allow_failure: true

check-fmt:
  stage: lint
  script: cargo fmt --check
  allow_failure: true

publish:
  stage: release
  script: cargo publish --target-dir ~/.cache/build-output/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_COMMIT_TITLE =~ /\d\.\d\.\d/
  artifacts:
    paths:
      - release/
#  release:
#    name: $CI_COMMIT_TITLE
#    tag_name: '$CI_COMMIT_TITLE'
#    ref: '$CI_COMMIT_TITLE'
#    description: '$CI_COMMIT_TITLE - Automatically Released'

benchmark:
  stage: benchmark
  script: cargo bench --target-dir ~/.cache/build-output/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH && $CI_COMMIT_TITLE =~ /\d\.\d\.\d/
  needs:
    - job: publish
  artifacts:
    paths:
      - bench/

coverage:
  stage: benchmark
  script: cargo tarpaulin --out Xml --target-dir ~/.cache/build-output/
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  coverage: '/^\d+.\d+% coverage/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: cobertura.xml